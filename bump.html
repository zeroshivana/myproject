<!DOCTYPE html> 
<html lang="zh-TW"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥§å¤šæ¯”ç¢°ç¢°æ¨‚</title>
    <!-- Import Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Adobe Dark Mode Palette */
            --bg-color: #1a1a1a;
            --panel-bg: #2b2b2b;
            --board-bg: #151515;
            --cell-bg: #323232;
            --text-primary: #f5f5f5;
            --text-secondary: #aaaaaa;
            --accent-blue: #0265DC;
            --accent-blue-hover: #0056b3;
            --border-color: #444;
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Header Area */
        .header-container {
            display: flex;
            width: 500px;
            max-width: 95vw;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .brand-area {
            display: flex;
            align-items: center;
            gap: 15px;
            /* Allow shrinking if needed on very small screens, but title has nowrap */
            flex-shrink: 1; 
            overflow: hidden;
        }

        .game-title {
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 28px; /* Slightly smaller */
            font-weight: 900; 
            color: var(--text-primary);
            letter-spacing: 1px;
            text-shadow: 0 2px 2px rgba(0,0,0,0.5);
            margin: 0;
            white-space: nowrap; /* Prevent line break */
        }

        .scores-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0; /* Keep scores from shrinking too much */
        }

        /* Panel Style Score Box */
        .score-box {
            background: var(--panel-bg);
            padding: 8px 15px;
            border-radius: 8px;
            min-width: 70px;
            text-align: right;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); 
        }
        
        .score-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .score-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        /* Controls & Info */
        .controls-bar {
            width: 500px;
            max-width: 95vw;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn {
            background-color: var(--panel-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 20px; 
            padding: 6px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
            box-shadow: 0 2px 0 #111;
            transform: translateY(0);
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 #111;
        }

        .btn-primary {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            box-shadow: 0 3px 0 #003d80; 
        }
        
        .btn-primary:active {
            box-shadow: 0 0 0 #003d80;
        }
        
        .btn-revive {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            box-shadow: 0 4px 0 #1e8449, 0 5px 10px rgba(46, 204, 113, 0.3);
            font-weight: bold;
            font-size: 16px;
            padding: 10px 20px;
            transition: all 0.1s;
        }
        
        .btn-revive:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #1e8449;
        }
        
        .btn-revive:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Improved Info Button with Text - No Emoji */
        .info-btn {
            background: #444;
            color: white;
            border: none;
            border-radius: 16px;
            padding: 6px 12px;
            height: auto;
            width: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 0 #222;
            transition: all 0.1s;
            margin-right: 10px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .info-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        .info-btn:hover {
            background-color: #555;
        }

        /* Game Board */
        #game-container {
            position: relative;
            width: 500px;
            height: 500px;
            max-width: 95vw;
            max-height: 95vw;
            background-color: var(--board-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.1); 
            touch-action: none;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            height: 100%;
        }

        .grid-cell {
            background-color: var(--cell-bg);
            border-radius: 8px;
            width: 100%;
            height: 100%;
            box-shadow: inset 1px 1px 4px rgba(0,0,0,0.4);
        }

        .tile-container {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            z-index: 1;
            pointer-events: none;
        }

        /* 3D Tile Design */
        .tile {
            position: absolute;
            width: calc(25% - 7.5px); 
            height: calc(25% - 7.5px);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 28px;
            color: white;
            text-align: center;
            transition: transform 0.08s ease-in-out, opacity 0.08s ease;
            animation: appear 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            box-shadow: 
                0 4px 0 rgba(0,0,0,0.3),
                0 5px 5px rgba(0,0,0,0.4);
            background-color: #333;
            overflow: hidden;
            transform-origin: center bottom;
        }

        .tile::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 45%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
            border-radius: 10px 10px 30% 30%;
            pointer-events: none;
        }

        .tile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            pointer-events: none;
        }
        
        .tile-4 img { transform: scale(1.02); }

        .tile .tile-text { display: none; position: absolute; z-index: 2; }
        .tile.fallback-mode .tile-text { display: block; }
        .tile.fallback-mode img { display: none; }

        .tile.merged {
            z-index: 10;
            animation: jelly-pop 0.3s ease;
        }

        @keyframes jelly-pop {
            0% { transform: scale(1); }
            30% { transform: scale(1.25); } 
            50% { transform: scale(0.9); }  
            70% { transform: scale(1.05); } 
            100% { transform: scale(1); }
        }

        @keyframes appear { 
            0% { opacity: 0; transform: scale(0); } 
            70% { opacity: 1; transform: scale(1.1); } 
            100% { opacity: 1; transform: scale(1); } 
        }

        /* Overlays */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 20, 20, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 8px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(8px);
            touch-action: none;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .overlay-text { font-size: 42px; font-weight: 700; color: white; margin-bottom: 20px; text-shadow: 0 4px 10px rgba(0,0,0,0.8); text-align: center; }
        .overlay-subtext { font-size: 16px; color: #ccc; margin-bottom: 20px; text-align: center; line-height: 1.5; padding: 0 20px;}
        .overlay-hint { font-size: 14px; color: #666; margin-top: 20px; }

        /* Lists */
        #leaderboard-overlay, #evolution-overlay {
            justify-content: flex-start;
            padding-top: 30px;
        }
        
        .modal-list {
            width: 85%;
            max-width: 320px;
            max-height: 70%;
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .leaderboard-item, .evolution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #444;
            font-size: 15px;
        }
        .leaderboard-item:last-child, .evolution-item:last-child { border-bottom: none; }
        
        .rank { color: var(--accent-blue); font-weight: bold; width: 30px; }
        .score { color: white; font-weight: bold; }
        .date { color: #888; font-size: 12px; }

        /* Evolution list styling */
        .evo-row { display: flex; align-items: center; width: 100%; }
        .evo-icon { 
            width: 36px; height: 36px; 
            border-radius: 8px; 
            object-fit: cover; 
            box-shadow: 0 2px 0 rgba(0,0,0,0.5);
            margin-right: 15px;
        }
        .evo-info { flex-grow: 1; display: flex; flex-direction: column; }
        .evo-name { color: #fff; font-weight: 600; font-size: 15px; }
        .evo-score { color: var(--accent-blue); font-size: 12px; font-family: monospace; margin-top: 2px;}
        .evo-arrow { color: #666; font-size: 12px; margin-right: 5px; }

        /* Instructions */
        .instructions-panel {
            margin-top: 20px;
            width: 500px;
            max-width: 95vw;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .key-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .key-icon {
            display: inline-block;
            border: 1px solid #555;
            border-bottom: 3px solid #333;
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 12px;
            background: #444;
            color: #ddd;
            transform: translateY(0);
        }

        .key-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Fallback Colors */
        .tile-2.fallback-mode { background: #E22C2C; } 
        .tile-4.fallback-mode { background: linear-gradient(135deg, #ff4d4d, #c0392b); }
        .tile-8.fallback-mode { background: linear-gradient(135deg, #f1c40f, #e67e22, #e74c3c, #9b59b6); }
        .tile-16.fallback-mode { background: #31a8ff; filter: hue-rotate(180deg); }
        .tile-32.fallback-mode { background: #31A8FF; color: #001e36; }
        .tile-64.fallback-mode { background: #FF9A00; color: #330000; }
        .tile-128.fallback-mode { background: #ff3366; }
        .tile-256.fallback-mode { background: #9999FF; color: #000044; }
        .tile-512.fallback-mode { background: #9999FF; color: #000044; }
        .tile-1024.fallback-mode { background: linear-gradient(45deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff); }

        @media (max-width: 520px) {
            .tile { font-size: 22px; }
            .header-container { flex-direction: column; align-items: flex-start; gap: 10px; }
            .scores-wrapper { width: 100%; justify-content: space-between; }
            .score-box { flex: 1; text-align: center; }
            .instructions-panel { flex-direction: column; gap: 15px; text-align: center; }
            .tile-container { top: 10px; left: 10px; right: 10px; bottom: 10px; }
        }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="brand-area">
            <h1 class="game-title">å¥§å¤šæ¯”ç¢°ç¢°æ¨‚</h1>
        </div>
        <div class="scores-wrapper">
            <button class="info-btn" onclick="game.showEvolution()">é€²åŒ–åœ–é‘‘</button>
            <div class="score-box">
                <div class="score-label">åˆ†æ•¸</div>
                <div class="score-value" id="score">0</div>
            </div>
            <div class="score-box">
                <div class="score-label">æœ€é«˜åˆ†</div>
                <div class="score-value" id="best-score">0</div>
            </div>
        </div>
    </div>

    <div class="controls-bar">
        <div class="status-text" id="status-msg">åˆä½µåœ–æ¨™ï¼Œè§£é–å…¨å¥—è»Ÿé«”ï¼</div>
        <div class="btn-group">
            <button class="btn" onclick="game.showLeaderboard()">ğŸ† æ’è¡Œæ¦œ</button>
            <button class="btn" id="sound-toggle" onclick="game.toggleSound()">ğŸ”Š éŸ³æ•ˆ</button>
            <button class="btn btn-primary" onclick="game.restart()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <div id="game-container">
        <div class="grid-container">
            <!-- 4x4 Grid (16 cells) -->
            <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        </div>
        <div class="tile-container" id="tile-container"></div>

        <!-- Game Over Overlay -->
        <div class="overlay" id="game-over">
            <div class="overlay-text">éŠæˆ²çµæŸ</div>
            <div class="overlay-subtext">åˆ¥æ°£é¤’ï¼ä½ å¯ä»¥é¸æ“‡æ¥é—œç¹¼çºŒæŒ‘æˆ°<br>(æ¯å±€é™ç”¨ä¸€æ¬¡ï¼Œæ¶ˆé™¤æœ€åº•å±¤)</div>
            
            <button class="btn btn-revive" id="revive-btn" onclick="game.revive()">ğŸ“º è§€çœ‹å»£å‘Š/åˆ†äº«æ¥é—œ</button>
            <button class="btn" style="margin-top:15px; background:transparent; border:none; text-decoration:underline; color:#888;" onclick="game.restart()">æ”¾æ£„ï¼Œé‡æ–°é–‹å§‹</button>
        </div>

        <!-- Win Overlay -->
        <div class="overlay" id="game-won">
            <div class="overlay-text" style="color:#00ff00; text-shadow:0 0 20px rgba(0,255,0,0.3);">æ­å–œç ´é—œ</div>
            <div class="overlay-subtext">
                æ‚¨å·²æˆåŠŸè§£é– Creative Cloud å…¨å¥—æˆæ¬Š<br><br>
                <span style="color: #fff; font-weight:bold; font-size: 20px;">è«‹æŒ‰å³ä¸Šæ–¹ ğŸ”„ é‡æ–°é–‹å§‹</span><br>
                <span style="font-size: 14px; color: #888;">ä»¥æŒ‘æˆ°æ›´é«˜åˆ†æ•¸</span>
            </div>
            
             <!-- Action Buttons -->
             <div style="display:flex; gap:15px; margin-bottom:15px; z-index:101;">
                <button class="btn btn-primary" onclick="game.shareResult(this)">ğŸ“¤ åˆ†äº«æˆ°ç¸¾</button>
                <button class="btn" onclick="document.getElementById('game-won').classList.remove('active')">æš«æ™‚éš±è—</button>
            </div>
        </div>

        <!-- Leaderboard Overlay -->
        <div class="overlay" id="leaderboard-overlay">
            <div class="overlay-text">ğŸ† é ‚å°–å‰µä½œè€…</div>
            <div class="modal-list" id="leaderboard-list"></div>
            <button class="btn btn-primary" onclick="game.hideOverlay('leaderboard')">é—œé–‰</button>
        </div>

        <!-- Evolution Overlay -->
        <div class="overlay" id="evolution-overlay">
            <div class="overlay-text">â„¹ï¸ é€²åŒ–åœ–é‘‘</div>
            <div class="modal-list" id="evolution-list"></div>
            <button class="btn btn-primary" onclick="game.hideOverlay('evolution')">é—œé–‰</button>
        </div>
    </div>

    <div class="instructions-panel">
        <div class="key-group">
            <span class="key-label">æ“ä½œ:</span>
            <div>
                <span class="key-icon">W</span><span class="key-icon">A</span><span class="key-icon">S</span><span class="key-icon">D</span>
            </div>
            <span class="key-label" style="margin: 0 5px;">æˆ–</span>
            <div>
                <span class="key-icon">â†‘</span><span class="key-icon">â†</span><span class="key-icon">â†“</span><span class="key-icon">â†’</span>
            </div>
        </div>
        <div class="status-text">
            æ‰‹æ©Ÿå¯ç›´æ¥æ»‘å‹•
        </div>
    </div>

    <script>
        class SoundManager {
            constructor() {
                this.enabled = true;
                this.ctx = null;
                const initOnce = () => {
                    this.init();
                    window.removeEventListener('click', initOnce);
                    window.removeEventListener('keydown', initOnce);
                    window.removeEventListener('touchstart', initOnce);
                };
                window.addEventListener('click', initOnce);
                window.addEventListener('keydown', initOnce);
                window.addEventListener('touchstart', initOnce);
            }
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }
            play(type) {
                if (!this.enabled || !this.ctx) return;
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const now = this.ctx.currentTime;

                if (type === 'move') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(300, now); osc.frequency.exponentialRampToValueAtTime(100, now+0.1);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now+0.1);
                    osc.start(now); osc.stop(now+0.1);
                } else if (type === 'merge') {
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(300, now); 
                    osc.frequency.linearRampToValueAtTime(600, now+0.1);
                    gain.gain.setValueAtTime(0.1, now); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now+0.2);
                    osc.start(now); osc.stop(now+0.2);
                } else if (type === 'gameover') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+1);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.001, now+1);
                    osc.start(now); osc.stop(now+1);
                } else if (type === 'win') {
                    this.playTone(523, now, 0.1); this.playTone(659, now+0.1, 0.1); this.playTone(783, now+0.2, 0.4);
                } else if (type === 'revive') {
                    this.playTone(400, now, 0.1); this.playTone(800, now+0.1, 0.3);
                }
            }
            playTone(f,t,d){
                const o=this.ctx.createOscillator();const g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);
                o.type='square';o.frequency.value=f;g.gain.setValueAtTime(0.05,t);g.gain.exponentialRampToValueAtTime(0.001,t+d);o.start(t);o.stop(t+d);
            }
            toggle() { 
                this.enabled = !this.enabled; 
                if(this.enabled) this.init();
                return this.enabled; 
            }
        }

        class Game2048 {
            constructor() {
                this.gridSize = 4;
                this.grid = [];
                this.score = 0;
                this.bestScore = localStorage.getItem('adobe_pong_best_4x4') || 0;
                this.over = false;
                this.won = false;
                this.keepPlaying = false;
                this.reviveUsed = false;
                this.sound = new SoundManager();
                
                this.iconMap = {
                    2: { text: 'Dc', fullName: 'Adobe Acrobat', url: 'https://adbeweblink.github.io/myproject/images/Dc.png' }, 
                    4: { text: 'Fi', fullName: 'Adobe Firefly', url: 'https://adbeweblink.github.io/myproject/images/fl.png' }, 
                    8: { text: 'Ex', fullName: 'Adobe Express', url: 'https://adbeweblink.github.io/myproject/images/Express.png' }, 
                    16: { text: 'Lr', fullName: 'Adobe Lightroom', url: 'https://adbeweblink.github.io/myproject/images/lr.png' }, 
                    32: { text: 'Ps', fullName: 'Adobe Photoshop', url: 'https://adbeweblink.github.io/myproject/images/ps.png' }, 
                    64: { text: 'Ai', fullName: 'Adobe Illustrator', url: 'https://adbeweblink.github.io/myproject/images/Ai.png' }, 
                    128: { text: 'Id', fullName: 'Adobe InDesign', url: 'https://adbeweblink.github.io/myproject/images/Id.png' }, 
                    256: { text: 'Pr', fullName: 'Adobe Premiere Pro', url: 'https://adbeweblink.github.io/myproject/images/Pr.png' }, 
                    512: { text: 'Ae', fullName: 'Adobe After Effects', url: 'https://adbeweblink.github.io/myproject/images/Ae.png' }, 
                    1024: { text: 'CC', fullName: 'Adobe Creative Cloud', url: 'https://adbeweblink.github.io/myproject/images/CC.png' }
                };

                this.tileContainer = document.getElementById('tile-container');
                this.scoreDisplay = document.getElementById('score');
                this.bestScoreDisplay = document.getElementById('best-score');
                this.msgDisplay = document.getElementById('status-msg');
                this.soundBtn = document.getElementById('sound-toggle');
                this.reviveBtn = document.getElementById('revive-btn');
                this.overlays = { 
                    over: document.getElementById('game-over'), 
                    won: document.getElementById('game-won'),
                    leaderboard: document.getElementById('leaderboard-overlay'),
                    evolution: document.getElementById('evolution-overlay')
                };

                this.bestScoreDisplay.textContent = this.bestScore;
                this.setupInput();
                this.restart();
            }

            toggleSound() {
                const isOn = this.sound.toggle();
                this.soundBtn.textContent = isOn ? 'ğŸ”Š éŸ³æ•ˆ' : 'ğŸ”‡ éœéŸ³';
                this.soundBtn.style.opacity = isOn ? 1 : 0.6;
            }

            restart() {
                this.grid = Array(this.gridSize).fill(null).map(() => Array(this.gridSize).fill(null));
                this.score = 0; 
                this.over = false; 
                this.won = false; 
                this.keepPlaying = false;
                this.reviveUsed = false;
                
                this.updateScoreDisplay(); 
                this.clearTiles();
                
                Object.values(this.overlays).forEach(el => el.classList.remove('active'));
                
                // Change status message to be descriptive
                this.msgDisplay.textContent = "åˆä½µåœ–æ¨™ï¼Œè§£é–å…¨å¥—è»Ÿé«”ï¼";
                
                this.reviveBtn.disabled = false;
                this.reviveBtn.innerHTML = "ğŸ“º è§€çœ‹å»£å‘Š/åˆ†äº«æ¥é—œ";
                
                this.addRandomTile(); 
                this.addRandomTile(); 
                this.updateView();
            }

            revive() {
                if (this.reviveUsed) return;
                
                const originalText = this.reviveBtn.innerHTML;
                this.reviveBtn.innerHTML = "å»£å‘Šè¼‰å…¥ä¸­...";
                this.reviveBtn.disabled = true;

                setTimeout(() => {
                    for (let c = 0; c < this.gridSize; c++) {
                        this.grid[3][c] = null;
                    }

                    this.reviveUsed = true;
                    this.over = false;
                    this.overlays.over.classList.remove('active');
                    this.sound.play('revive');
                    this.updateView();
                    this.msgDisplay.textContent = "å¾©æ´»æˆåŠŸï¼æœ€åº•å±¤å·²æ¸…ç©ºï¼";
                }, 1000);
            }
            
            saveScore() {
                let scores = JSON.parse(localStorage.getItem('adobe_pong_leaderboard_4x4') || '[]');
                const now = new Date();
                const dateStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                scores.push({ score: this.score, date: dateStr });
                scores.sort((a,b) => b.score - a.score);
                scores = scores.slice(0, 5);
                localStorage.setItem('adobe_pong_leaderboard_4x4', JSON.stringify(scores));
            }
            
            showLeaderboard() {
                const scores = JSON.parse(localStorage.getItem('adobe_pong_leaderboard_4x4') || '[]');
                const listEl = document.getElementById('leaderboard-list');
                listEl.innerHTML = '';
                
                if (scores.length === 0) {
                    listEl.innerHTML = '<div style="text-align:center; color:#888;">æš«ç„¡ç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°ï¼</div>';
                } else {
                    scores.forEach((s, index) => {
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.innerHTML = `
                            <span class="rank">#${index+1}</span>
                            <span class="score">${s.score}</span>
                            <span class="date">${s.date}</span>
                        `;
                        listEl.appendChild(item);
                    });
                }
                this.overlays.leaderboard.classList.add('active');
            }

            showEvolution() {
                const listEl = document.getElementById('evolution-list');
                listEl.innerHTML = '';
                
                const values = [2, 4, 8, 16, 32, 64, 128, 256, 512, 1024];
                values.forEach((val, index) => {
                    const info = this.iconMap[val];
                    const item = document.createElement('div');
                    item.className = 'evolution-item';
                    item.innerHTML = `
                        <div class="evo-row">
                            <img src="${info.url}" class="evo-icon" onerror="this.style.display='none'">
                            <div class="evo-info">
                                <span class="evo-name">${info.fullName}</span>
                                <span class="evo-score">Score: ${val}</span>
                            </div>
                            ${index < values.length - 1 ? '<span class="evo-arrow">â–¼</span>' : ''}
                        </div>
                    `;
                    listEl.appendChild(item);
                });
                this.overlays.evolution.classList.add('active');
            }
            
            hideOverlay(name) {
                this.overlays[name].classList.remove('active');
            }
            
            copyToClipboard(text, btn) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = btn.textContent;
                    btn.textContent = "å·²è¤‡è£½ï¼";
                    setTimeout(() => btn.textContent = originalText, 2000);
                } catch (err) {
                    console.error('Fallback error', err);
                }
                document.body.removeChild(textArea);
            }

            shareResult(btn) {
                const text = `æˆ‘åœ¨å¥§å¤šæ¯”ç¢°ç¢°æ¨‚ç²å¾—äº† ${this.score} åˆ†ï¼æˆåŠŸè§£é–å…¨å¥— Adobe Creative Cloudï¼å¿«ä¾†æŒ‘æˆ°ï¼`;
                if (navigator.share) {
                    navigator.share({
                        title: 'å¥§å¤šæ¯”ç¢°ç¢°æ¨‚',
                        text: text,
                        url: window.location.href
                    }).catch(console.error);
                } else {
                    this.copyToClipboard(text, btn);
                }
            }

            addRandomTile() {
                const empty = [];
                for (let r=0; r<this.gridSize; r++) for (let c=0; c<this.gridSize; c++) if (!this.grid[r][c]) empty.push({r,c});
                if (empty.length) {
                    const {r,c} = empty[Math.floor(Math.random()*empty.length)];
                    this.grid[r][c] = { value: Math.random()<0.9?2:4, id: Math.random().toString(36).substr(2) };
                }
            }

            move(dir) {
                if (this.over || Object.values(this.overlays).some(el => el.classList.contains('active'))) return;
                
                let moved = false;
                let mergedThisTurn = false;
                let mergedIds = new Set();
                const vectors = { 'up':{x:0,y:-1}, 'down':{x:0,y:1}, 'left':{x:-1,y:0}, 'right':{x:1,y:0} };
                const v = vectors[dir];

                let xs = [], ys = [];
                for(let i=0; i<this.gridSize; i++) { xs.push(i); ys.push(i); }
                
                if (v.x===1) xs.reverse(); if (v.y===1) ys.reverse();

                xs.forEach(x => { ys.forEach(y => {
                    let cell = this.grid[y][x];
                    if (cell) {
                        let pos = this.findFarthest({x,y}, v);
                        let next = this.getCell(pos.next);
                        if (next && next.value === cell.value && !mergedIds.has(next.id)) {
                            let merged = { value: cell.value*2, id: Math.random().toString(36), mergedFrom: [cell, next] };
                            mergedIds.add(merged.id);
                            this.grid[y][x] = null;
                            this.grid[pos.next.y][pos.next.x] = merged;
                            this.score += merged.value;
                            
                            if (merged.value === 1024 && !this.won) {
                                this.won = true;
                                setTimeout(() => { 
                                    this.sound.play('win'); 
                                    this.overlays.won.classList.add('active'); 
                                }, 300);
                            }
                            
                            moved = true; mergedThisTurn = true;
                        } else if (pos.farthest.x !== x || pos.farthest.y !== y) {
                            this.grid[y][x] = null;
                            this.grid[pos.farthest.y][pos.farthest.x] = cell;
                            moved = true;
                        }
                    }
                })});

                if (moved) {
                    this.sound.play(mergedThisTurn ? 'merge' : 'move');
                    this.addRandomTile();
                    this.updateScoreDisplay();
                    this.updateView();
                    
                    setTimeout(() => {
                        if (!this.movesAvailable()) {
                            this.over = true;
                            if(this.score > this.bestScore) {
                                localStorage.setItem('adobe_pong_best_4x4', this.score);
                            }
                            
                            this.sound.play('gameover');
                            this.overlays.over.classList.add('active');
                            
                            if(this.reviveUsed) {
                                this.reviveBtn.disabled = true;
                                this.reviveBtn.innerHTML = "ğŸš« å·²ä½¿ç”¨éæ¥é—œ";
                            }
                        }
                    }, 150);
                }
            }

            findFarthest(cell, v) {
                let prev;
                do { prev = cell; cell = {x: prev.x + v.x, y: prev.y + v.y}; } 
                while (this.inBounds(cell) && !this.getCell(cell));
                return { farthest: prev, next: cell };
            }
            inBounds(p) { return p.x>=0 && p.x<this.gridSize && p.y>=0 && p.y<this.gridSize; }
            getCell(p) { return this.inBounds(p) ? this.grid[p.y][p.x] : null; }
            
            movesAvailable() {
                for(let y=0; y<this.gridSize; y++) for(let x=0; x<this.gridSize; x++) {
                    if(!this.grid[y][x]) return true;
                    if(x<this.gridSize-1 && this.grid[y][x].value == this.grid[y][x+1]?.value) return true;
                    if(y<this.gridSize-1 && this.grid[y][x].value == this.grid[y+1][x]?.value) return true;
                }
                return false;
            }

            clearTiles() { this.tileContainer.innerHTML = ''; }
            updateView() {
                this.tileContainer.innerHTML = '';
                for (let y=0; y<this.gridSize; y++) for (let x=0; x<this.gridSize; x++) {
                    if (this.grid[y][x]) this.addTile(x, y, this.grid[y][x]);
                }
            }

            addTile(x, y, data) {
                const el = document.createElement('div');
                const tileInfo = this.iconMap[data.value] || { text: data.value, url: '' };
                
                el.className = `tile tile-${data.value} tile-pos-${x}-${y}`;
                if (data.mergedFrom) el.classList.add('merged');
                
                const img = document.createElement('img');
                img.src = tileInfo.url;
                img.alt = tileInfo.text;
                img.onerror = () => { el.classList.add('fallback-mode'); };
                
                const txt = document.createElement('span');
                txt.className = 'tile-text';
                txt.textContent = tileInfo.text;
                
                el.appendChild(img);
                el.appendChild(txt);
                
                this.tileContainer.appendChild(el);
            }

            updateScoreDisplay() {
                this.scoreDisplay.textContent = this.score;
                if (this.score > this.bestScore) {
                    this.bestScore = this.score;
                    localStorage.setItem('adobe_pong_best_4x4', this.bestScore);
                }
                this.bestScoreDisplay.textContent = this.bestScore;
            }

            setupInput() {
                window.addEventListener('keydown', e => {
                    const k = e.key.toLowerCase();
                    const map = { 'arrowup':'up', 'w':'up', 'arrowdown':'down', 's':'down', 'arrowleft':'left', 'a':'left', 'arrowright':'right', 'd':'right' };
                    if (map[k]) { e.preventDefault(); this.move(map[k]); }
                });

                const c = document.getElementById('game-container');
                let sx, sy;
                c.addEventListener('mousedown', e => { sx=e.clientX; sy=e.clientY; });
                c.addEventListener('mouseup', e => { 
                    if (!sx) return;
                    const dx = e.clientX - sx;
                    const dy = e.clientY - sy;
                    if (Math.max(Math.abs(dx), Math.abs(dy)) > 30) {
                        this.move(Math.abs(dx)>Math.abs(dy) ? (dx>0?'right':'left') : (dy>0?'down':'up'));
                    }
                    sx=null; 
                });
                
                c.addEventListener('touchstart', e => { sx=e.touches[0].clientX; sy=e.touches[0].clientY; e.preventDefault(); }, {passive:false});
                c.addEventListener('touchend', e => {
                    if (!sx || !sy) return;
                    const dx = e.changedTouches[0].clientX - sx;
                    const dy = e.changedTouches[0].clientY - sy;
                    if (Math.max(Math.abs(dx), Math.abs(dy)) > 30) {
                        this.move(Math.abs(dx)>Math.abs(dy) ? (dx>0?'right':'left') : (dy>0?'down':'up'));
                    }
                    sx=null; sy=null;
                });
            }
        }

        const style = document.createElement("style");
        let css = "";
        for(let x=0; x<4; x++) for(let y=0; y<4; y++) {
            css += `.tile-pos-${x}-${y} { left: calc(25% * ${x} + ${x*2.5}px); top: calc(25% * ${y} + ${y*2.5}px); }`;
        }
        style.innerText = css;
        document.head.appendChild(style);

        const game = new Game2048();
    </script>
</body>
</html>
