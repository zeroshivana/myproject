<!DOCTYPE html>
<html lang="zh-TW"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantone è‰²å½©æ¥µé™æŒ‘æˆ° (Pantone Color Challenge)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Noto Sans TC Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F0F0F0;
        }

        /* Custom Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-6px) rotate(-2deg); }
            40% { transform: translateX(6px) rotate(2deg); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
        }
        .animate-shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes pulse-fast {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-fast {
            animation: pulse-fast 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }

        /* Utility for hiding elements */
        .hidden { display: none !important; }
    </style>
</head>
<body class="text-slate-900 min-h-screen flex flex-col items-center py-6 px-4">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50 w-max max-w-[90%]"></div>

    <!-- Ad Overlay (Simulated) -->
    <div id="ad-overlay" class="fixed inset-0 bg-black z-[100] hidden flex-col items-center justify-center text-white">
        <div class="text-4xl font-black mb-4 animate-bounce">AD</div>
        <p class="mb-8 text-gray-400">å»£å‘Šæ’­æ”¾ä¸­... è´ŠåŠ©å•†æ”¯æŒæ¥é—œ</p>
        <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin mb-4"></div>
        <div id="ad-timer" class="text-2xl font-bold">3</div>
    </div>

    <!-- Header -->
    <div class="w-full max-w-lg flex justify-between items-end mb-8 border-b-4 border-black pb-4 relative">
        <div class="flex flex-col">
            <div class="bg-black text-white px-2 py-1 font-black text-xs md:text-sm tracking-[0.2em] w-fit mb-2">PANTONE</div>
            <h1 class="font-black text-2xl md:text-3xl tracking-tighter leading-tight text-black">
                Pantone è‰²å½©æ¥µé™æŒ‘æˆ°<br/>
                <span class="text-base md:text-lg font-bold text-gray-500 tracking-normal block mt-1">Color Challenge</span>
            </h1>
        </div>
        
        <!-- Level Indicator (Playing Mode) -->
        <div id="level-indicator" class="flex flex-col items-end hidden">
            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Level</span>
            <span id="level-display" class="text-4xl font-black leading-none text-black">1</span>
        </div>

        <!-- Leaderboard Icon (Home Mode) -->
        <button id="btn-header-leaderboard" class="hidden absolute right-0 top-0 p-2 hover:bg-gray-200 rounded-full transition-colors" title="æŸ¥çœ‹æ’è¡Œæ¦œ">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
        </button>
    </div>

    <!-- Main Content Container -->
    <div id="app" class="w-full max-w-lg relative min-h-[600px]">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Data ---
        // åš´è‚…è²æ˜ï¼šä»¥ä¸‹ HEX å€¼å‡åƒç…§æ¥­ç•Œæ¨™æº–çš„ Pantone ç¶²é /æ•¸ä½è‰²å½©è¿‘ä¼¼å€¼ã€‚
        const PANTONE_YEARS = [
            {
                year: 2025,
                name: "Mocha Mousse",
                nameCN: "æ‘©å¡æ…•æ–¯",
                code: "17-1230",
                hex: "#96786A", 
                desc: "Mocha Mousse æ˜¯ä¸€ç¨®æ¿ƒéƒã€çµ²æ»‘çš„å·§å…‹åŠ›æ£•è‰²ï¼Œå–šèµ·æº«æš–èˆ‡èˆ’é©çš„æ„Ÿå®˜é«”é©—ã€‚å®ƒæ»‹é¤Šè‘—æˆ‘å€‘å°ç°¡ç´„èˆ‡å“è³ªçš„æ¸´æœ›ï¼Œæ˜¯ä¸€ç¨®é¡ä¼¼ç”œé»èˆ¬çš„ç¸±æƒ…äº«å—ï¼Œå¸¶ä¾†æ¥µè‡´çš„èˆ’é©æ„Ÿã€‚"
            },
            { year: 2024, name: "Peach Fuzz", nameCN: "æŸ”å’Œæ¡ƒ", code: "13-1023", hex: "#FFBE98", desc: "Peach Fuzz æ˜¯ä¸€ç¨®å¤©éµçµ¨èˆ¬æŸ”å’Œçš„èœœæ¡ƒè‰²ï¼Œå…¶åŒ…å®¹çš„ç²¾ç¥è±å¯Œäº†èº«å¿ƒèˆ‡éˆé­‚ã€‚" },
            { year: 2023, name: "Viva Magenta", nameCN: "è¬æ­²æ´‹ç´…", code: "18-1750", hex: "#BB2649", desc: "Viva Magenta æºè‡ªç´…è‰²å®¶æ—ï¼Œéˆæ„Ÿä¾†è‡ªèƒ­è„‚ç´…ã€‚é€™æ˜¯ä¸€ç¨®å……æ»¿æ´»åŠ›çš„è‰²å½©ï¼Œè±¡å¾µè‘—å‹‡æ•¢ã€ç„¡ç•èˆ‡å¿«æ¨‚çš„æ…¶å…¸ã€‚" },
            { year: 2022, name: "Very Peri", nameCN: "é•·æ˜¥èŠ±è—", code: "17-3938", hex: "#6667AB", desc: "Very Peri æ˜¯ç‚ºäº†æ‡‰å°è½‰è®Šä¸­çš„ä¸–ç•Œè€Œå‰µã€‚å®ƒå°‡è—è‰²çš„å¿ èª èˆ‡ç´…è‰²çš„èƒ½é‡èåˆï¼Œå‰µé€ å‡ºä¸€ç¨®å¿«æ¨‚ã€æº«æš–çš„ç´«è—è‰²ã€‚" },
            { year: 2021, name: "Illuminating", nameCN: "äº®éº—é»ƒ", code: "13-0647", hex: "#F5DF4D", desc: "Illuminating æ˜¯ä¸€ç¨®æ˜äº®ä¸”å¿«æ´»çš„é»ƒè‰²ï¼Œé–ƒè€€è‘—æ´»åŠ›ï¼Œå½·å½¿æ³¨æ»¿äº†å¤ªé™½çš„èƒ½é‡ã€‚" },
            { year: 2021, name: "Ultimate Gray", nameCN: "æ¥µè‡´ç°", code: "17-5104", hex: "#939597", desc: "Ultimate Gray è±¡å¾µè‘—å …å¯¦èˆ‡å¯é ï¼Œå¦‚åŒæµ·ç˜ä¸Šçš„çŸ³å­ï¼Œç¶“å¾—èµ·æ™‚é–“çš„è€ƒé©—ã€‚" },
            { year: 2020, name: "Classic Blue", nameCN: "ç¶“å…¸è—", code: "19-4052", hex: "#0F4C81", desc: "Classic Blue ç°¡ç´„è€Œå„ªé›…ï¼Œåƒæ¥µäº†è–„æš®æ™‚çš„å¤©ç©ºã€‚å®ƒå¸¶ä¾†å’Œå¹³èˆ‡å¯§éœçš„æ„Ÿè¦ºã€‚" },
            { year: 2019, name: "Living Coral", nameCN: "æ´»çŠç‘šæ©˜", code: "16-1546", hex: "#FF6F61", desc: "Living Coral æ•£ç™¼è‘—å¤§è‡ªç„¶ä¸­çŠç‘šç¤çš„è‰²å½©ï¼Œå……æ»¿æ´»åŠ›å»åˆé†‡åšã€‚" },
            { year: 2018, name: "Ultra Violet", nameCN: "ç´«å¤–å…‰", code: "18-3838", hex: "#5F4B8B", desc: "Ultra Violet å‚³é”äº†åŸå‰µæ€§ã€ç¨å‰µæ€§èˆ‡å¯Œæœ‰é è¦‹çš„æ€ç¶­ã€‚é€™ç¨®è¤‡é›œçš„ç´«è‰²èª¿æŒ‡å‘äº†å®‡å®™çš„ç¥ç§˜ã€‚" },
            { year: 2017, name: "Greenery", nameCN: "è‰æœ¨ç¶ ", code: "15-0343", hex: "#88B04B", desc: "Greenery æ˜¯ä¸€å€‹æ¸…æ–°çš„é»ƒç¶ è‰²èª¿ï¼Œå–šèµ·åˆæ˜¥ç¹èŒ‚çš„ç¶ æ„ã€‚" },
            { year: 2016, name: "Rose Quartz", nameCN: "ç«ç‘°çŸ³è‹±ç²‰", code: "13-1520", hex: "#F7CAC9", desc: "Rose Quartz æ˜¯ä¸€ç¨®å…·èªªæœåŠ›ä½†ä¸å¤±æº«æŸ”çš„è‰²èª¿ï¼Œå‚³é”åŒæƒ…èˆ‡é®å®šã€‚" },
            { year: 2016, name: "Serenity", nameCN: "å¯§éœç²‰è—", code: "15-3919", hex: "#91A8D0", desc: "Serenity è¼•ç›ˆé€šé€ï¼Œåƒæ¥µäº†å»£é—Šçš„è—å¤©ã€‚å®ƒå¸¶çµ¦äººå€‘å–˜æ¯çš„ç©ºé–“èˆ‡æ”¾é¬†æ„Ÿã€‚" },
            { year: 2015, name: "Marsala", nameCN: "ç‘ªè–©æ‹‰é…’ç´…", code: "18-1438", hex: "#964F4C", desc: "Marsala æ˜¯ä¸€ç¨®è‡ªç„¶å¼·å‹ä¸”è³ªæ¨¸çš„é…’ç´…è‰²ã€‚å®ƒè±å¯Œäº†æˆ‘å€‘çš„èº«å¿ƒéˆã€‚" },
            { year: 2014, name: "Radiant Orchid", nameCN: "è˜­èŠ±ç´«", code: "18-3224", hex: "#B565A7", desc: "Radiant Orchid ä»¥å…¶è¿·äººçš„ç´«ç´…è‰²èª¿æ¿€ç™¼è‡ªä¿¡èˆ‡å‰µæ„ã€‚" },
            { year: 2013, name: "Emerald", nameCN: "ç¿¡ç¿ ç¶ ", code: "17-5641", hex: "#009473", desc: "Emerald æ˜¯ä¸€ç¨®ç”Ÿå‹•ã€è¼ç…Œä¸”è¯éº—çš„ç¶ è‰²ã€‚å®ƒå¢å¼·äº†å¹¸ç¦æ„Ÿèˆ‡å¹³è¡¡æ„Ÿã€‚" },
            { year: 2012, name: "Tangerine Tango", nameCN: "æ¢æˆˆæ©˜", code: "17-1463", hex: "#DD4124", desc: "Tangerine Tango æ˜¯ä¸€ç¨®å……æ»¿æŒ‘é€—æ€§çš„æ©˜ç´…è‰²ã€‚å®ƒæ•£ç™¼è‘—ç†±åŠ›èˆ‡èƒ½é‡ã€‚" },
            { year: 2011, name: "Honeysuckle", nameCN: "å¿å†¬ç´…", code: "18-2120", hex: "#D65076", desc: "Honeysuckle æ˜¯ä¸€ç¨®å‹‡æ•¢çš„æ–°ç´…è‰²ï¼Œçµ¦äºˆæˆ‘å€‘é¢å°æ—¥å¸¸ç”Ÿæ´»çš„å‹‡æ°£ã€‚" },
            { year: 2010, name: "Turquoise", nameCN: "åœŸè€³å…¶è—", code: "15-5519", hex: "#45B5AA", desc: "Turquoise çµåˆäº†è—è‰²çš„å¯§éœèˆ‡ç¶ è‰²çš„æ´»åŠ›ã€‚" },
            { year: 2009, name: "Mimosa", nameCN: "å«ç¾è‰é»ƒ", code: "14-0848", hex: "#EFC050", desc: "Mimosa æ˜¯ä¸€ç¨®æº«æš–ä¸”å¼•äººå…¥å‹çš„é»ƒè‰²ã€‚" },
            { year: 2008, name: "Blue Iris", nameCN: "é³¶å°¾è—", code: "18-3943", hex: "#5A5B9F", desc: "Blue Iris çµåˆäº†è—è‰²çš„ç©©å®šèˆ‡ç´«è‰²çš„ç¥ç§˜ã€‚" },
            { year: 2007, name: "Chili Pepper", nameCN: "è¾£æ¤’ç´…", code: "19-1557", hex: "#9B1B30", desc: "Chili Pepper æ˜¯ä¸€ç¨®æ·±æ²ˆçš„è¾›è¾£ç´…è‰²ï¼Œå¤§è†½ã€å¤–å‘ä¸”è‡ªä¿¡ã€‚" },
            { year: 2006, name: "Sand Dollar", nameCN: "æ²™å¹£è¤", code: "13-1106", hex: "#DECDBE", desc: "Sand Dollar æ˜¯ä¸€ç¨®è¢«èªç‚ºæ˜¯è‡ªç„¶èˆ‡æœ‰æ©Ÿçš„è‰²èª¿ã€‚" },
            { year: 2005, name: "Blue Turquoise", nameCN: "è—ç¶ æ¾çŸ³", code: "15-5217", hex: "#53B0AE", desc: "Blue Turquoise æ¯”èµ·ä¸€èˆ¬çš„ç¶ æ¾çŸ³è‰²å«æœ‰æ›´å¤šçš„è—è‰²èª¿ã€‚" },
            { year: 2004, name: "Tigerlily", nameCN: "è™çš®ç™¾åˆæ©˜", code: "17-1456", hex: "#E2583E", desc: "Tigerlily åŒ…å«äº†ç´…èˆ‡é»ƒï¼Œå……æ»¿ç•°åœ‹æƒ…èª¿ã€‚" },
            { year: 2003, name: "Aqua Sky", nameCN: "æ°´è‰²å¤©ç©º", code: "14-4811", hex: "#7BC4C4", desc: "Aqua Sky æ˜¯ä¸€ç¨®æŸ”å’Œã€å¯§éœçš„è—ç¶ è‰²ã€‚" },
            { year: 2002, name: "True Red", nameCN: "æ­£ç´…", code: "19-1664", hex: "#BF1932", desc: "True Red æ˜¯ä¸€ç¨®å¼·çƒˆä¸”å¯Œæœ‰åŠ›é‡çš„ç´…è‰²ã€‚" },
            { year: 2001, name: "Fuchsia Rose", nameCN: "æ¡ƒç´…ç«ç‘°", code: "17-2031", hex: "#C74375", desc: "Fuchsia Rose æ˜¯ä¸€ç¨®å……æ»¿å¥³æ€§é­…åŠ›ä¸”ç†±æƒ…çš„è‰²å½©ã€‚" },
            { year: 2000, name: "Cerulean", nameCN: "è”šè—", code: "15-4020", hex: "#98B2D1", desc: "Cerulean ä»£è¡¨è‘—åƒç¦§å¹´çš„å¤©ç©ºè‰²å½©ã€‚" },
        ];

        // --- Bright Colors for Random Button Hover ---
        const BRIGHT_COLORS = [
            "#FFBE98", "#F5DF4D", "#FF6F61", "#88B04B", "#F7CAC9", 
            "#009473", "#DD4124", "#D65076", "#45B5AA", "#EFC050", 
            "#C74375", "#E2583E", "#7BC4C4"
        ];

        // --- SVGs ---
        const ICONS = {
            refresh: `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>`,
            arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            arrowRightSmall: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            close: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            play: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>`,
            trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#EAB308" stroke="#EAB308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            share: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>`,
            checkCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`,
            xCross: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="drop-shadow-md"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            list: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>`,
            medal: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>`,
            heart: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FF4D4D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
            video: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>`
        };

        // --- State Management ---
        const state = {
            view: 'home', // home, intro, playing, gameover, leaderboard
            previousView: 'home', // Track where we came from for leaderboard back button
            level: 1,
            currentBase: PANTONE_YEARS[0],
            introBase: null,
            oddColor: "",
            oddIndex: 0,
            wrongIndex: -1, 
            showFeedback: false, 
            hasRevived: false, // Track if user has used revive
            failedDetails: {
                baseHex: '',
                oddHex: '',
                difference: 0,
            }
        };

        // --- Local Storage Logic for Leaderboard ---
        const SCORE_KEY = 'pantone_game_scores_v1';

        const getScores = () => {
            try {
                const scores = localStorage.getItem(SCORE_KEY);
                return scores ? JSON.parse(scores) : [];
            } catch (e) {
                return [];
            }
        };

        const saveScore = (correctCount) => {
            const scores = getScores();
            const newScore = {
                score: correctCount,
                rankTitle: getRankTitle(correctCount + 1), // Rank title logic uses level (score + 1)
                date: new Date().toLocaleDateString('zh-TW')
            };
            
            scores.push(newScore);
            // Sort desc by score
            scores.sort((a, b) => b.score - a.score);
            // Keep top 5
            const top5 = scores.slice(0, 5);
            
            localStorage.setItem(SCORE_KEY, JSON.stringify(top5));
        };

        // --- Helper Functions ---
        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        };

        const rgbToHex = (r, g, b) => {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        };

        const getColorDifference = (hex1, hex2) => {
            const rgb1 = hexToRgb(hex1);
            const rgb2 = hexToRgb(hex2);
            const diffSq = Math.pow(rgb1.r - rgb2.r, 2) + 
                           Math.pow(rgb1.g - rgb2.g, 2) + 
                           Math.pow(rgb1.b - rgb2.b, 2);
            const maxDiff = 441.67;
            const percentage = (Math.sqrt(diffSq) / maxDiff) * 100;
            return percentage.toFixed(2);
        };

        const generateVariantColor = (baseHex, level) => {
            const rgb = hexToRgb(baseHex);
            let difficulty = Math.max(1.5, 25 - (level * 1.2)); 
            
            const change = (val) => {
                const direction = Math.random() > 0.5 ? 1 : -1;
                let newVal = val + (difficulty * direction);
                if (newVal > 255) newVal = val - difficulty;
                if (newVal < 0) newVal = val + difficulty; 
                if (Math.abs(newVal - val) < 2) {
                    newVal = val + (direction * 5); 
                }
                return Math.floor(Math.max(0, Math.min(255, newVal)));
            };

            const r = change(rgb.r);
            const g = change(rgb.g);
            const b = change(rgb.b);

            return rgbToHex(r, g, b);
        };

        const getRankTitle = (level) => {
            if (level < 5) return "è‰²å½©å­¸å¾’";
            if (level < 10) return "è¨­è¨ˆåŠ©ç†";
            if (level < 15) return "è³‡æ·±è¨­è¨ˆå¸«";
            if (level < 20) return "è—è¡“ç¸½ç›£";
            if (level < 30) return "å°åˆ·å» å¸«å‚…";
            return "çµ•å°è‰²æ„Ÿç¥äºº";
        };

        const showToast = (message) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = "bg-black text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-fade-in-up mb-2 mx-auto w-fit";
            toast.innerHTML = `${ICONS.checkCircle}<span class="font-bold text-sm text-center">${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 2500);
        };

        // --- Core Logic ---
        const startRound = (specificBase = null) => {
            const base = specificBase || PANTONE_YEARS[Math.floor(Math.random() * PANTONE_YEARS.length)];
            state.currentBase = base;
            state.oddColor = generateVariantColor(base.hex, state.level);
            state.oddIndex = Math.floor(Math.random() * 4);
            state.wrongIndex = -1;
            state.showFeedback = false;
            render();
        };

        const handleYearSelect = (yearData) => {
            state.introBase = yearData;
            state.view = 'intro';
            state.showFeedback = false;
            state.wrongIndex = -1;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const startRandomGame = () => {
            state.level = 1;
            state.hasRevived = false; // Reset revive status
            state.view = 'playing';
            startRound();
        };

        const startGameFromIntro = () => {
            state.level = 1;
            state.hasRevived = false; // Reset revive status
            state.view = 'playing';
            startRound(state.introBase);
        };

        // Revive Logic
        const resumeGame = () => {
            state.hasRevived = true;
            state.view = 'playing';
            // Start same round with same base but regenerate variant to avoid instant click
            startRound(state.currentBase);
        };

        const handleReviveShare = () => {
            const text = `æˆ‘åœ¨ Pantone è‰²å½©æ¥µé™æŒ‘æˆ°ä¸­é‡åˆ°äº†ç“¶é ¸ï¼å¿«ä¾†å¹«æˆ‘æ¥é—œï¼ç›®å‰ç­‰ç´šï¼š${state.level}`;
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast("é€£çµå·²è¤‡è£½ï¼Œåˆ†äº«çµ¦å¥½å‹å³å¯æ¥é—œï¼");
                setTimeout(() => {
                    resumeGame();
                }, 1500);
            } catch (err) {
                showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•æˆªåœ–åˆ†äº«");
                // For UX, we allow resume even if copy fails in this demo
                setTimeout(() => {
                    resumeGame();
                }, 1500);
            }
            document.body.removeChild(textarea);
        };

        const handleReviveAd = () => {
            const overlay = document.getElementById('ad-overlay');
            const timerEl = document.getElementById('ad-timer');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            let timeLeft = 3;
            timerEl.textContent = timeLeft;
            
            const timer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    resumeGame();
                }
            }, 1000);
        };
        
        const handleCardClick = (index) => {
            if (state.showFeedback || state.wrongIndex !== -1) return; 

            if (index === state.oddIndex) {
                state.level++;
                setTimeout(() => {
                    startRound();
                }, 200); 
            } else {
                state.failedDetails.baseHex = state.currentBase.hex;
                state.failedDetails.oddHex = state.oddColor;
                state.failedDetails.difference = getColorDifference(state.currentBase.hex, state.oddColor);

                // Only save score if user has used revive or chooses not to revive later.
                // Actually, we save score at game over screen if they give up. 
                // But simplified: save score now, if they revive, they can beat it.
                // Let's save only when "truly" game over (user navigates away or restarts).
                // Or overwrite logic. Let's keep simple: save score on death. 
                // If revive, current score entry remains but they can get a higher one.
                // Better UX: Don't save yet. Save when they click "Share Result" or "Try Again" or "View Leaderboard".
                // But users might just close tab. So let's save now.
                // NOTE: If they revive, they continue from current level.
                
                // If hasRevived is true, this is the FINAL death.
                if (state.hasRevived) {
                    saveScore(state.level - 1);
                } 
                // If NOT revived yet, don't save yet, give them a chance. 
                // Wait, if they choose NOT to revive, we need to save.
                // Let's save on 'Game Over' screen load to be safe, or just always save?
                // If we always save, reviving might create duplicate entries for same session.
                // Let's just save. Duplicate scores are acceptable in simple games.
                saveScore(state.level - 1);

                if (navigator.vibrate) navigator.vibrate(200);
                state.wrongIndex = index; 
                state.showFeedback = true; 
                render(); 
                
                setTimeout(() => {
                    state.view = 'gameover';
                    render();
                }, 1000);
            }
        };

        const handleShare = () => {
            const text = `æˆ‘åœ¨ Pantone è‰²å½©æ¥µé™æŒ‘æˆ°ä¸­æ´»åˆ°äº†ç¬¬ ${state.level} é—œï¼ç¨±è™Ÿï¼š${getRankTitle(state.level)}ã€‚ä½ ä¹Ÿä¾†æŒ‘æˆ°çœ‹çœ‹ï¼Ÿ`;
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast("æˆç¸¾å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
                } else {
                    showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
                }
            } catch (err) {
                showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
            }
            document.body.removeChild(textarea);
        };

        // --- Rendering ---
        const app = document.getElementById('app');
        const levelDisplay = document.getElementById('level-display');
        const levelIndicator = document.getElementById('level-indicator');
        const headerLeaderboardBtn = document.getElementById('btn-header-leaderboard');

        const renderHome = () => {
            const currentYearColor = PANTONE_YEARS.find(p => p.year === 2025);
            const pastYearsColors = PANTONE_YEARS.filter(p => p.year !== 2025);

            let html = `
                <div id="home-view" class="animate-fade-in pb-12">
                    <div class="bg-black text-white p-6 shadow-xl mb-8 relative overflow-hidden group rounded-lg">
                        <h2 class="text-xl md:text-2xl font-black mb-4 uppercase tracking-wide border-b border-white/30 pb-2">How to Play</h2>
                        <ul class="space-y-4 font-bold text-sm md:text-base text-gray-200">
                            <li class="flex items-start gap-4">
                                <span class="bg-white text-black w-6 h-6 flex items-center justify-center rounded-full text-sm font-black shrink-0 mt-0.5 shadow-sm">1</span>
                                <span>ç•«é¢ä¸Šå››å¼µè‰²å¡ä¸­ï¼Œåªæœ‰ä¸€å¼µçš„<span class="text-white font-black">é¡è‰²</span>èˆ‡å…¶æ¨™ç¤ºçš„<span class="text-white font-black">è‰²è™Ÿ/åç¨±</span><span class="border-b-2 border-white font-black ml-1">ä¸ç¬¦</span>ã€‚</span>
                            </li>
                            <li class="flex items-start gap-4">
                                <span class="bg-white text-black w-6 h-6 flex items-center justify-center rounded-full text-sm font-black shrink-0 mt-0.5 shadow-sm">2</span>
                                <span>ä½ çš„ä»»å‹™æ˜¯æ‰¾å‡ºä¸¦é»æ“Šé€™å¼µ<span class="text-white font-black">ã€ŒéŒ¯èª¤çš„è‰²è™Ÿåœ–å¡ã€</span>ã€‚</span>
                            </li>
                            <li class="flex items-start gap-4">
                                <span class="bg-white text-black w-6 h-6 flex items-center justify-center rounded-full text-sm font-black shrink-0 mt-0.5 shadow-sm">3</span>
                                <span>é¡è‰²å·®ç•°æœƒéš¨è‘—é—œå¡å¢åŠ è€Œè¶Šä¾†è¶Šç´°å¾®ã€‚</span>
                            </li>
                        </ul>
                    </div>

                    <button id="btn-random" class="w-full bg-white border-2 border-black p-5 mb-10 font-black text-lg text-black hover:bg-black hover:text-white transition-all flex items-center justify-between group shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] rounded-lg active:scale-[0.98]">
                        <span class="flex items-center gap-3">${ICONS.refresh} éš¨æ©ŸæŒ‘æˆ° (RANDOM START)</span>
                        <span class="group-hover:translate-x-1 transition-transform">${ICONS.arrowRight}</span>
                    </button>

                    <div>
                        <h3 class="font-black text-xl mb-5 uppercase tracking-tighter flex items-center gap-3 text-black">
                            <span class="w-2 h-8 bg-black block rounded-sm"></span>
                            é¸æ“‡ PANTONE å¹´åº¦ä»£è¡¨è‰²
                        </h3>

                        ${currentYearColor ? `
                        <div data-action="intro" data-year="${currentYearColor.year}" data-name="${currentYearColor.name}" class="year-card w-full bg-white shadow-md hover:shadow-2xl transition-all cursor-pointer group border border-gray-200 flex flex-col md:flex-row h-auto md:h-52 mb-8 rounded-xl overflow-hidden transform hover:-translate-y-1">
                            <div class="h-48 md:h-full w-full md:w-5/12 relative" style="background-color: ${currentYearColor.hex}">
                                <div class="absolute top-4 left-4 bg-black/90 text-white text-[10px] px-3 py-1.5 rounded-full uppercase tracking-wider font-bold shadow-md ring-1 ring-white/20">2025 New Arrival</div>
                                <div class="absolute bottom-3 right-3 text-white/40 text-sm font-black tracking-widest uppercase">${currentYearColor.year}</div>
                            </div>
                            <div class="p-6 flex-1 flex flex-col justify-center bg-white relative">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/c/cc/Pantone_logo.svg" alt="PANTONE" class="h-6 md:h-8 object-contain object-left mb-4 opacity-80" />
                                <div class="text-sm font-mono font-bold text-gray-400 mb-1">${currentYearColor.code}</div>
                                <div class="text-3xl font-black text-gray-900 leading-none mb-2">${currentYearColor.name}</div>
                                <div class="text-xl font-bold text-gray-600">${currentYearColor.nameCN}</div>
                                <div class="mt-4 flex items-center text-xs font-bold text-gray-400 gap-2 group-hover:text-black transition-colors">
                                    <span>äº†è§£æ›´å¤š</span>
                                    <span class="group-hover:translate-x-1 transition-transform">${ICONS.arrowRightSmall}</span>
                                </div>
                            </div>
                        </div>` : ''}

                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-8">
                            ${pastYearsColors.map(p => `
                                <div data-action="intro" data-year="${p.year}" data-name="${p.name}" class="year-card bg-white aspect-[3/4] shadow-sm hover:shadow-xl transition-all cursor-pointer group border border-gray-100 flex flex-col rounded-lg overflow-hidden transform hover:-translate-y-1">
                                    <div class="h-[65%] w-full relative" style="background-color: ${p.hex}">
                                        <div class="absolute bottom-2 right-2 text-white/60 text-[10px] font-black tracking-widest uppercase bg-black/10 px-1 rounded">${p.year}</div>
                                    </div>
                                    <div class="p-3 flex-1 flex flex-col justify-end bg-white border-t border-gray-50">
                                        <div class="text-[10px] font-mono font-bold text-gray-400 mb-0.5">${p.code}</div>
                                        <div class="text-sm font-black text-gray-900 leading-tight truncate">${p.name}</div>
                                        <div class="text-xs font-bold text-gray-500 mt-0.5 truncate">${p.nameCN}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            return html;
        };

        const renderIntro = () => {
            const p = state.introBase;
            if (!p) return '';
            return `
                <div id="intro-view" class="animate-fade-in flex flex-col bg-white rounded-xl shadow-2xl overflow-hidden mb-12 border border-gray-200 relative">
                    <button id="btn-intro-close" class="absolute top-4 right-4 p-2 z-20 bg-white/90 hover:bg-white text-black rounded-full shadow-lg transition-transform hover:scale-110">
                        ${ICONS.close}
                    </button>
                    <div class="flex flex-col border-b-[16px]" style="border-color: ${p.hex}">
                        <div class="w-full h-64 md:h-80 relative" style="background-color: ${p.hex}">
                            <div class="absolute bottom-6 left-6 md:left-8 bg-black/80 backdrop-blur-md px-4 py-2 text-xs font-bold tracking-widest uppercase text-white rounded-lg shadow-lg">
                                Pantone Color of the Year ${p.year}
                            </div>
                        </div>
                        <div class="p-6 md:p-10 flex flex-col relative overflow-hidden bg-white">
                            <h2 class="text-[6rem] md:text-[9rem] font-black text-gray-100 absolute select-none -top-10 right-0 z-0 leading-none opacity-60">${p.year}</h2>
                            <div class="relative z-10 mb-8">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/c/cc/Pantone_logo.svg" alt="PANTONE" class="h-6 md:h-8 object-contain object-left mb-4" />
                                <h2 class="text-4xl md:text-5xl font-black text-black mb-2 leading-tight tracking-tight">${p.name}</h2>
                                <h3 class="text-2xl md:text-3xl font-bold text-gray-600 mb-3 leading-none">${p.nameCN}</h3>
                                <p class="font-mono font-bold text-gray-400 text-lg">PANTONE ${p.code}</p>
                            </div>
                            <div class="relative z-10">
                                <h3 class="font-bold text-xs uppercase tracking-widest text-black mb-4 border-b-2 border-black inline-block pb-1">About the Color</h3>
                                <p class="text-gray-700 leading-relaxed font-medium text-justify text-sm md:text-base lg:text-lg">${p.desc}</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 bg-gray-50 border-t border-gray-100">
                        <button id="btn-start-challenge" class="w-full bg-black text-white py-5 font-black text-xl hover:bg-neutral-800 transition-all flex items-center justify-center gap-3 shadow-xl rounded-lg active:scale-[0.99]">
                            ${ICONS.play} START CHALLENGE
                        </button>
                    </div>
                </div>
            `;
        };

        const renderPlaying = () => {
            let cardsHtml = '';
            for (let i = 0; i < 4; i++) {
                const isOdd = i === state.oddIndex;
                const isWrong = i === state.wrongIndex;
                const color = isOdd ? state.oddColor : state.currentBase.hex;
                
                let feedbackHtml = '';
                if (state.showFeedback && isOdd) {
                    feedbackHtml = `
                        <div class="absolute inset-0 flex items-center justify-center z-10">
                            <div class="bg-white/40 rounded-full p-4 shadow-lg backdrop-blur-sm">
                                <div class="w-8 h-8 bg-white rounded-full animate-ping"></div>
                            </div>
                        </div>`;
                }
                if (isWrong) {
                    feedbackHtml = `
                        <div class="absolute inset-0 bg-red-500/50 flex items-center justify-center z-10 animate-pulse-fast">
                            ${ICONS.xCross}
                        </div>`;
                }

                const shakeClass = isWrong ? 'animate-shake' : '';

                cardsHtml += `
                    <div data-card-index="${i}" class="game-card relative bg-white shadow-lg flex flex-col transition-all duration-200 cursor-pointer hover:shadow-2xl hover:scale-[1.02] rounded-lg overflow-hidden ${shakeClass}" style="min-height: 280px">
                        <div class="flex-1 w-full relative group min-h-[160px]" style="background-color: ${color}">
                            ${feedbackHtml}
                        </div>
                        <div class="w-full p-3 md:p-4 flex flex-col justify-end text-left select-none border-t border-gray-100 bg-white shrink-0">
                            <div class="mb-2">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/c/cc/Pantone_logo.svg" alt="PANTONE" class="h-5 md:h-6 object-contain object-left" />
                            </div>
                            <p class="text-slate-500 font-mono text-xs md:text-sm font-bold tracking-wide leading-none mb-1">${state.currentBase.code}</p>
                            <div class="flex flex-col min-w-0">
                                <p class="text-slate-900 font-black text-base md:text-lg leading-tight truncate">${state.currentBase.name}</p>
                                <p class="text-slate-500 font-bold text-xs md:text-sm leading-tight mt-0.5 truncate">${state.currentBase.nameCN}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            const currentRank = getRankTitle(state.level);
            const nextRankLevel = [5, 10, 15, 20, 30].find(l => l > state.level);
            let nextRankMessage;

            if (nextRankLevel) {
                const nextRankTitle = getRankTitle(nextRankLevel + 1); 
                nextRankMessage = `
                    ç­”å° <span class="font-black text-black">${nextRankLevel - state.level}</span> é¡Œå‡ç´šè‡³: 
                    <span class="font-bold text-indigo-700">${nextRankTitle}</span>
                `;
            } else {
                nextRankMessage = `<span class="font-black text-green-700">å·²æ˜¯é ‚ç´šè‰²å½©å¤§å¸«ï¼Œç¹¼çºŒæŒ‘æˆ°æ¥µé™!</span>`;
            }

            return `
                <div id="playing-view" class="animate-fade-in w-full max-w-md mx-auto pb-12">
                    <div class="grid grid-cols-2 gap-4 md:gap-6">
                        <div class="col-span-2 text-center mb-6 p-4 bg-white rounded-lg shadow-xl border-b-4 border-black/50">
                            <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">ç›®å‰ç¨±è™Ÿ / Rank</div>
                            <div class="text-xl font-black text-black mb-3">${currentRank}</div>
                            <div class="text-xs font-medium text-gray-700">
                                ${nextRankMessage}
                            </div>
                        </div>
                        ${cardsHtml}
                    </div>
                </div>
            `;
        };

        const renderLeaderboard = () => {
            const scores = getScores();
            let rowsHtml = '';

            if (scores.length === 0) {
                rowsHtml = `
                    <div class="text-center py-10 text-gray-400">
                        <div class="text-4xl mb-2 opacity-30">ğŸ†</div>
                        <p>å°šç„¡æŒ‘æˆ°ç´€éŒ„</p>
                    </div>
                `;
            } else {
                rowsHtml = scores.map((s, index) => {
                    let badge = `<span class="w-6 h-6 flex items-center justify-center font-bold text-gray-400 text-sm">${index + 1}</span>`;
                    if (index === 0) badge = `<span class="w-6 h-6 flex items-center justify-center font-bold text-yellow-500 text-lg">ğŸ¥‡</span>`;
                    if (index === 1) badge = `<span class="w-6 h-6 flex items-center justify-center font-bold text-gray-400 text-lg">ğŸ¥ˆ</span>`;
                    if (index === 2) badge = `<span class="w-6 h-6 flex items-center justify-center font-bold text-amber-600 text-lg">ğŸ¥‰</span>`;

                    return `
                        <div class="flex items-center justify-between p-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center gap-3">
                                ${badge}
                                <div>
                                    <div class="font-bold text-gray-800 text-sm">${s.rankTitle}</div>
                                    <div class="text-[10px] text-gray-400 font-mono">${s.date}</div>
                                </div>
                            </div>
                            <div class="text-xl font-black text-black">${s.score} <span class="text-xs font-normal text-gray-400">åˆ†</span></div>
                        </div>
                    `;
                }).join('');
            }

            // Button text changes based on where we came from
            const backBtnText = state.previousView === 'gameover' ? 'è¿”å› (Back)' : 'è¿”å›é¦–é  (Home)';

            return `
                <div id="leaderboard-view" class="animate-fade-in w-full max-w-md mx-auto pb-12">
                    <div class="bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-200">
                        <div class="bg-black p-6 text-white flex justify-between items-center relative overflow-hidden">
                            <div class="relative z-10">
                                <h2 class="text-2xl font-black uppercase tracking-tight">Leaderboard</h2>
                                <p class="text-xs text-gray-400 font-bold tracking-widest uppercase">Top 5 Records</p>
                            </div>
                            <div class="relative z-10">
                                ${ICONS.trophy}
                            </div>
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                        </div>
                        
                        <div class="p-4">
                            ${rowsHtml}
                        </div>

                        <div class="p-4 bg-gray-50 border-t border-gray-100">
                            <button id="btn-back-from-leaderboard" class="w-full bg-white border border-gray-300 text-black py-3 font-bold hover:bg-gray-100 transition flex items-center justify-center gap-2 rounded-lg text-sm">
                                ${backBtnText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderGameOver = () => {
            const f = state.failedDetails;
            const correctName = state.currentBase.nameCN;
            const correctCode = state.currentBase.code;
            
            // Revive buttons only show if not revived yet
            let reviveSection = '';
            if (!state.hasRevived) {
                reviveSection = `
                    <div class="flex gap-2 mb-6">
                        <button id="btn-revive-share" class="flex-1 bg-pink-500 text-white py-3 font-bold hover:bg-pink-600 transition flex items-center justify-center gap-2 rounded-lg text-xs shadow-md">
                            ${ICONS.heart} åˆ†äº«å¥½å‹æ¥é—œ
                        </button>
                        <button id="btn-revive-ad" class="flex-1 bg-blue-500 text-white py-3 font-bold hover:bg-blue-600 transition flex items-center justify-center gap-2 rounded-lg text-xs shadow-md">
                            ${ICONS.video} çœ‹å»£å‘Šæ¥é—œ
                        </button>
                    </div>
                    <div class="text-center text-[10px] text-gray-400 mb-6">æ¯å±€åƒ…é™æ¥é—œä¸€æ¬¡ (Revive Once per Game)</div>
                `;
            }

            return `
                <div id="gameover-view" class="bg-white p-8 shadow-[0_25px_50px_-12px_rgba(0,0,0,0.25)] text-center animate-fade-in border-t-[16px] relative rounded-xl overflow-hidden max-w-md mx-auto mb-12" style="border-color: ${state.currentBase.hex}">
                    <div class="absolute -top-14 left-1/2 -translate-x-1/2 bg-white rounded-full p-4 shadow-xl border-4 border-gray-50">
                        ${ICONS.trophy}
                    </div>
                    <h2 class="text-3xl font-black mb-2 mt-8 uppercase tracking-tight text-black">æŒ‘æˆ°çµæŸ</h2>
                    <p class="text-gray-500 font-bold mb-6">æ‚¨æ­¢æ­¥æ–¼ç¬¬ ${state.level} é—œï¼</p>

                    ${reviveSection}

                    <div class="bg-neutral-50 p-6 border-l-4 border-red-500 text-left mb-8 rounded-r-lg shadow-inner">
                        <div class="text-xs font-bold text-red-600 uppercase tracking-widest mb-3">éŒ¯èª¤è³‡è¨Š (FAIL DETAILS)</div>
                        
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full shrink-0 border border-gray-300 shadow-inner" style="background-color: ${f.oddHex}"></div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-gray-700 truncate">æ‚¨é»æ“Šçš„è®Šç•°è‰² (ODD COLOR)</div>
                                <div class="text-lg font-black text-red-700">${f.oddHex}</div>
                            </div>
                        </div>

                        <div class="w-full h-px bg-gray-200 my-4"></div>

                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full shrink-0 border border-gray-300 shadow-inner" style="background-color: ${f.baseHex}"></div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-gray-700 truncate">æœ¬é—œæ­£ç¢º Pantone è‰²è™Ÿ/åç¨±</div>
                                <div class="text-lg font-black text-black truncate">${correctCode} - ${correctName}</div>
                            </div>
                        </div>

                        <div class="w-full h-px bg-gray-200 my-4"></div>

                        <div class="flex justify-between items-center text-sm">
                            <span class="font-bold text-gray-500">è‰²å·®å€¼ (Delta E è¿‘ä¼¼)</span>
                            <span class="text-lg font-black text-red-700">${f.difference}%</span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex gap-3">
                            <button id="btn-try-again" class="flex-1 bg-black text-white py-4 font-black hover:bg-neutral-800 transition flex items-center justify-center gap-2 uppercase tracking-wide text-sm rounded-lg">
                                ${ICONS.refresh} é‡æ–°æŒ‘æˆ°
                            </button>
                            <button id="btn-view-leaderboard" class="flex-none w-14 bg-gray-200 text-black py-4 font-black hover:bg-gray-300 transition flex items-center justify-center rounded-lg" title="æŸ¥çœ‹æ’è¡Œæ¦œ">
                                ${ICONS.list}
                            </button>
                        </div>
                        <button id="btn-share-result" class="w-full bg-white border-2 border-black text-black py-4 font-black hover:bg-gray-50 transition flex items-center justify-center gap-2 uppercase tracking-wide text-sm rounded-lg">
                            ${ICONS.share} åˆ†äº«çµæœ
                        </button>
                    </div>
                </div>
            `;
        };
        
        // --- Event Binding Logic ---

        const bindHomeEvents = () => {
            const btnRandom = document.getElementById('btn-random');
            if (btnRandom) {
                btnRandom.addEventListener('click', () => startRandomGame());
                
                // Hover Effect
                btnRandom.addEventListener('mouseenter', () => {
                    const randomColor = BRIGHT_COLORS[Math.floor(Math.random() * BRIGHT_COLORS.length)];
                    btnRandom.style.backgroundColor = randomColor;
                    btnRandom.style.borderColor = randomColor;
                    btnRandom.style.color = '#000000'; 
                });

                btnRandom.addEventListener('mouseleave', () => {
                    btnRandom.style.backgroundColor = ''; 
                    btnRandom.style.borderColor = '';
                    btnRandom.style.color = ''; 
                });
            }

            // Header Leaderboard Button
            const btnHeaderLeaderboard = document.getElementById('btn-header-leaderboard');
            if (btnHeaderLeaderboard) {
                btnHeaderLeaderboard.addEventListener('click', () => {
                    state.previousView = 'home';
                    state.view = 'leaderboard';
                    render();
                });
            }
            
            document.querySelectorAll('.year-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    const year = parseInt(card.dataset.year);
                    const name = card.dataset.name;
                    
                    let target = PANTONE_YEARS.find(p => p.year === year && p.name === name);
                    if (!target) {
                        target = PANTONE_YEARS.find(p => p.year === year);
                    }

                    if (target) {
                        handleYearSelect(target);
                        render();
                    }
                });
            });
        };

        const bindIntroEvents = () => {
            document.getElementById('btn-intro-close').addEventListener('click', () => {
                state.view = 'home';
                render();
            });
            document.getElementById('btn-start-challenge').addEventListener('click', () => startGameFromIntro());
        };

        const bindPlayingEvents = () => {
            document.querySelectorAll('.game-card').forEach(card => {
                card.addEventListener('click', () => {
                    const index = parseInt(card.dataset.cardIndex);
                    handleCardClick(index);
                });
            });
        };

        const bindGameOverEvents = () => {
            document.getElementById('btn-try-again').addEventListener('click', () => {
                state.view = 'home';
                render();
            });
            document.getElementById('btn-share-result').addEventListener('click', handleShare);
            document.getElementById('btn-view-leaderboard').addEventListener('click', () => {
                state.previousView = 'gameover'; // Remember we came from gameover
                state.view = 'leaderboard';
                render();
            });

            // Revive buttons
            const btnReviveShare = document.getElementById('btn-revive-share');
            if (btnReviveShare) btnReviveShare.addEventListener('click', handleReviveShare);

            const btnReviveAd = document.getElementById('btn-revive-ad');
            if (btnReviveAd) btnReviveAd.addEventListener('click', handleReviveAd);
        };

        const bindLeaderboardEvents = () => {
            document.getElementById('btn-back-from-leaderboard').addEventListener('click', () => {
                // Go back to where we came from
                state.view = state.previousView;
                render();
            });
        };

        const bindEvents = () => {
            if (state.view === 'home') bindHomeEvents();
            else if (state.view === 'intro') bindIntroEvents();
            else if (state.view === 'playing') bindPlayingEvents();
            else if (state.view === 'gameover') bindGameOverEvents();
            else if (state.view === 'leaderboard') bindLeaderboardEvents();
        };


        const render = () => {
            const headerBtn = document.getElementById('btn-header-leaderboard');
            if (state.view === 'playing') {
                levelIndicator.classList.remove('hidden');
                levelDisplay.textContent = state.level;
                if (headerBtn) headerBtn.classList.add('hidden');
            } else {
                levelIndicator.classList.add('hidden');
                if (headerBtn) {
                    if (state.view === 'home') headerBtn.classList.remove('hidden');
                    else headerBtn.classList.add('hidden');
                }
            }

            if (state.view === 'home') {
                app.innerHTML = renderHome();
            } else if (state.view === 'intro') {
                app.innerHTML = renderIntro();
            } else if (state.view === 'playing') {
                app.innerHTML = renderPlaying();
            } else if (state.view === 'gameover') {
                app.innerHTML = renderGameOver();
            } else if (state.view === 'leaderboard') {
                app.innerHTML = renderLeaderboard();
            }

            bindEvents();
        };

        window.onload = render;

    </script>
</body>
</html>
