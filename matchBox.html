<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¥§å¤šæ¯”æ¶ˆæ¶ˆæ¨‚ - æŒ‘æˆ°è³½</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap');
        
        /* ç¦æ­¢é è¨­è§¸æ§è¡Œç‚º (ç‚ºæ»‘å‹•åŠŸèƒ½åšæº–å‚™) */
        body { 
            font-family: 'Inter', sans-serif; 
            user-select: none; 
            -webkit-user-select: none;
            touch-action: none; 
            overscroll-behavior: none;
            background-color: #111827;
        }
        
        .grid-cell { 
            will-change: transform; 
            transform: translateZ(0);
            border-radius: 8px; /* è®“æ–¹å¡Šåœ“æ½¤ä¸€é» */
            overflow: hidden;
        }
        
        .selected {
            filter: brightness(1.2);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.6);
            z-index: 20 !important;
        }

        /* æ¶ˆé™¤å‹•ç•« */
        .match-anim { animation: popOut 0.3s ease-out forwards; z-index: 10; }
        @keyframes popOut {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.8; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* ç„¡æ•ˆäº¤æ›æ™ƒå‹• */
        .shake-anim { animation: shake 0.3s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px) rotate(-2deg); }
            75% { transform: translateX(4px) rotate(2deg); }
        }

        /* æŒ‰éˆ•å‘¼å¸ç‡ˆç‰¹æ•ˆ */
        .pulse-btn { animation: pulseBtn 2s infinite; }
        @keyframes pulseBtn {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .reward-pulse { animation: rewardPulse 2s infinite; }
        @keyframes rewardPulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(234, 179, 8, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }

        /* ç‰¹æ®Šæ–¹å¡Š */
        .mystery-pulse { animation: mysteryPulse 1.5s infinite; }
        @keyframes mysteryPulse {
            0% { filter: drop-shadow(0 0 2px #fff); transform: scale(1); }
            50% { filter: drop-shadow(0 0 8px #D29BFF); transform: scale(1.05); }
            100% { filter: drop-shadow(0 0 2px #fff); transform: scale(1); }
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 2px; }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col items-center justify-center fixed w-full h-full">

    <div id="app" class="w-full max-w-lg h-full flex flex-col p-4 relative justify-center gap-4">
        
        <div class="flex justify-between items-end w-full px-2">
            <div>
                <div class="text-[10px] text-gray-400">SCORE</div>
                <div id="score-display" class="text-4xl font-black text-yellow-400 font-mono leading-none">0</div>
            </div>
            <div class="flex flex-col items-center flex-1 mx-4">
                <div class="text-[10px] text-gray-400 mb-1">LV.<span id="level-display">1</span></div>
                <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                    <div id="level-progress" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-gray-400">TIME</div>
                <div id="time-display" class="text-4xl font-black text-red-400 font-mono leading-none">60</div>
            </div>
        </div>

        <div id="game-container" class="w-full aspect-square bg-gray-800/50 rounded-xl p-2 relative shadow-2xl border border-gray-700">
            <div id="game-grid" class="w-full h-full grid grid-cols-8 gap-1 relative touch-none"></div>
            
            <div id="overlay" class="absolute inset-0 bg-gray-900/95 z-30 flex flex-col items-center justify-center rounded-xl backdrop-blur-sm p-6 text-center">
                
                <div id="start-screen" class="w-full space-y-6">
                    <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-400 to-purple-500 mb-2 drop-shadow-sm">å¥§å¤šæ¯”<br>æ¶ˆæ¶ˆæ¨‚</h1>
                    <div class="text-xs text-gray-400 tracking-widest uppercase">SWIPE TO MATCH</div>
                    
                    <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg pulse-btn active:scale-95 transition text-xl">
                        é–‹å§‹éŠæˆ²
                    </button>
                    
                    <div class="bg-gray-800/80 rounded-lg p-4 text-left w-full border border-gray-700">
                        <h3 class="text-xs text-gray-400 mb-2 border-b border-gray-600 pb-1">ğŸ† æ‚¨çš„æœ€ä½³ç´€éŒ„</h3>
                        <div id="local-best-list" class="space-y-1 text-sm font-mono min-h-[60px]">
                            <div class="text-gray-500 text-xs text-center py-4">å°šç„¡ç´€éŒ„</div>
                        </div>
                    </div>
                </div>

                <div id="game-over-screen" class="hidden w-full space-y-4">
                    <h2 class="text-3xl font-bold text-white">æ™‚é–“åˆ°ï¼</h2>
                    
                    <div class="bg-gray-800 p-6 rounded-2xl border border-gray-600 w-full">
                        <div class="text-xs text-gray-400 mb-1">æœ¬æ¬¡å¾—åˆ†</div>
                        <div id="final-score" class="text-5xl text-yellow-400 font-mono font-bold">0</div>
                        <div id="new-record-badge" class="hidden mt-2 inline-block bg-red-600 text-white text-[10px] px-2 py-0.5 rounded font-bold animate-bounce">æ–°ç´€éŒ„!</div>
                    </div>

                    <button id="claim-reward-btn" class="hidden w-full bg-gradient-to-r from-yellow-500 to-amber-600 text-black font-black py-4 rounded-xl shadow-xl reward-pulse active:scale-95 transition flex items-center justify-center gap-2">
                        <span>ğŸ</span> é ˜å–é€šé—œçå‹µ
                    </button>

                    <div class="flex gap-2 w-full">
                        <button id="restart-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-xl font-bold transition">å†ç©ä¸€æ¬¡</button>
                        <button id="share-btn" class="flex-1 bg-[#06C755] hover:bg-[#05b34c] py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                            åˆ†äº«å¥½å‹
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full bg-gray-800/50 rounded-full h-8 flex items-center px-4 overflow-hidden border border-gray-700">
            <div id="tips-text" class="text-xs text-gray-400 whitespace-nowrap"></div>
        </div>

    </div>

    <script>
        // === è¨­å®šå€ ===
        const LIFF_ID = '2008592497-pvgkXmM2'; // æ‚¨çš„ LIFF ID
        const REWARD_SCORE_THRESHOLD = 10000;
        const BOTBONNIE_KEYWORD = '#winæ¶ˆæ¶ˆæ¨‚';
        const STORAGE_KEY = 'adobe_game_local_best';
        
        const GRID_SIZE = 8;
        const BASE_TIME = 60;
        const ALL_TILES = [
            { id: 'Ps', file: 'Adobe_Photoshop_CC_icon.svg', color: '#31A8FF' },
            { id: 'Ai', file: 'Adobe_Illustrator_CC_icon.svg', color: '#FF9A00' },
            { id: 'Ac', file: 'Adobe_Acrobat_DC_logo_2020.svg', color: '#FF0000' },
            { id: 'Fl', file: 'Adobe_Firefly_Logo.svg', color: '#00D084' },
            { id: 'Pr', file: 'Adobe_Premiere_Pro_CC_icon.svg', color: '#9999FF' },
        ];
        // ç‚ºäº†è®“æ‰‹æ©Ÿç•«é¢ä¸æ“æ“ ï¼Œæˆ‘æ¸›å°‘äº†é è¨­çš„åœ–ç¤ºç¨®é¡ï¼Œç¢ºä¿æ–¹å¡Šé¡è‰²é®®æ˜å¥½è¾¨è­˜

        const TIPS = [
            "ğŸ’¡ æç¤ºï¼šæŒ‰ä½æ–¹å¡Šä¸¦å¾€ä¸Šä¸‹å·¦å³æ»‘å‹•å³å¯äº¤æ›ï¼",
            "ğŸ’¡ Psï¼šé¸å–å·¥å…·æŒ‰ Shift å¯ä»¥å¢åŠ é¸å–ç¯„åœ",
            "ğŸ’¡ Aiï¼šCtrl+Y å¯ä»¥åˆ‡æ›å¤–æ¡†æ¨¡å¼æª¢è¦–",
            "ğŸ’¡ Prï¼šæŒ‰ ` éµå¯ä»¥å°‡é¸å–çš„è¦–çª—æœ€å¤§åŒ–",
            "ğŸ’¡ ç‚¸å½ˆæ–¹å¡Šå¯ä»¥æ¶ˆé™¤å‘¨åœä¹å®®æ ¼ï¼"
        ];

        // ç‹€æ…‹
        let grid = [];
        let score = 0;
        let timeLeft = BASE_TIME;
        let activeTileTypes = 5;
        let isProcessing = false;
        let gameInterval = null;
        let selectedTile = null; // é»æ“Šæ¨¡å¼ç”¨
        
        // è§¸æ§æ»‘å‹•è®Šæ•¸
        let touchStart = null;
        let activeTouchTile = null;

        // DOM
        const els = {
            grid: document.getElementById('game-grid'),
            score: document.getElementById('score-display'),
            time: document.getElementById('time-display'),
            overlay: document.getElementById('overlay'),
            startScn: document.getElementById('start-screen'),
            endScn: document.getElementById('game-over-screen'),
            finalScore: document.getElementById('final-score'),
            rewardBtn: document.getElementById('claim-reward-btn'),
            bar: document.getElementById('level-progress'),
            lvl: document.getElementById('level-display'),
            tips: document.getElementById('tips-text'),
            localList: document.getElementById('local-best-list'),
            newRecord: document.getElementById('new-record-badge')
        };

        // --- LIFF åˆå§‹åŒ– ---
        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
            } catch (e) { console.error('LIFF Init Failed', e); }
        }

        // --- æ’è¡Œæ¦œ (æœ¬æ©Ÿå„²å­˜) ---
        function updateLocalLeaderboard(currentScore) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            // æª¢æŸ¥æ˜¯å¦æ–°ç´€éŒ„
            const maxScore = records.length > 0 ? records[0].score : 0;
            if (currentScore > maxScore && currentScore > 0) {
                els.newRecord.classList.remove('hidden');
            } else {
                els.newRecord.classList.add('hidden');
            }

            // åŠ å…¥æ–°åˆ†æ•¸
            if (currentScore > 0) {
                records.push({ score: currentScore, date: new Date().toLocaleDateString() });
                records.sort((a, b) => b.score - a.score); // é™åº
                records = records.slice(0, 5); // åªç•™å‰5
                localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            }
            
            // æ¸²æŸ“ç•«é¢
            if (records.length === 0) {
                els.localList.innerHTML = '<div class="text-gray-500 text-xs text-center py-4">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°ï¼</div>';
            } else {
                els.localList.innerHTML = records.map((r, i) => `
                    <div class="flex justify-between items-center border-b border-gray-700/50 pb-1 last:border-0">
                        <span class="${i===0?'text-yellow-400 font-bold':'text-gray-400'}">#${i+1}</span>
                        <span class="text-gray-500 text-[10px]">${r.date}</span>
                        <span class="text-white font-mono">${r.score}</span>
                    </div>
                `).join('');
            }
        }

        // --- éŠæˆ²æ ¸å¿ƒ ---
        function getImg(data) {
            if (!data) return '';
            if (data.id === 'Mystery') return `<div class="w-full h-full bg-indigo-600 flex items-center justify-center text-white font-black text-2xl mystery-pulse rounded-lg">?</div>`;
            if (data.id === 'Bomb') return `<div class="w-full h-full bg-gray-900 flex items-center justify-center text-2xl rounded-lg">ğŸ’£</div>`;
            return `<img src="https://commons.wikimedia.org/wiki/Special:FilePath/${data.file}" class="w-full h-full object-contain drop-shadow-md pointer-events-none" onerror="this.style.display='none'">`;
        }

        function initGame() {
            score = 0; timeLeft = BASE_TIME; isProcessing = false;
            els.score.innerText = 0; els.time.innerText = timeLeft; els.lvl.innerText = 1;
            els.bar.style.width = '0%';
            
            grid = []; els.grid.innerHTML = '';
            for(let y=0; y<GRID_SIZE; y++) {
                let row = [];
                for(let x=0; x<GRID_SIZE; x++) {
                    const t = createTile(x,y);
                    row.push(t);
                    els.grid.appendChild(t.el);
                }
                grid.push(row);
            }
            
            checkMatchesAndRefill(); // åˆå§‹ç›¤é¢æ•´ç†
            
            els.overlay.classList.add('hidden');
            els.startScn.classList.add('hidden');
            els.endScn.classList.add('hidden');
            
            if(gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                timeLeft--;
                els.time.innerText = timeLeft;
                if(timeLeft <= 0) endGame();
            }, 1000);
            
            startTips();
        }

        function createTile(x, y) {
            const el = document.createElement('div');
            // touch-action: none å¾ˆé‡è¦ï¼Œé˜²æ­¢æ»‘å‹•æ™‚è§¸ç™¼ç€è¦½å™¨æ»¾å‹•
            el.className = 'absolute p-1 transition-transform duration-200 ease-out cursor-pointer';
            el.style.width = '12.5%';
            el.style.height = '12.5%';
            el.style.left = (x * 12.5) + '%';
            el.style.top = (y * 12.5) + '%';

            let data = ALL_TILES[Math.floor(Math.random() * ALL_TILES.length)];
            // éš¨æ©Ÿç”Ÿæˆç‰¹æ®Šæ–¹å¡Š
            if (Math.random() < 0.03) data = {id: 'Bomb'};
            else if (Math.random() < 0.03) data = {id: 'Mystery'};

            el.innerHTML = getImg(data);

            const tileObj = { x, y, data, el };

            // === ç¶å®šäº‹ä»¶ (åŒæ™‚æ”¯æ´æ»‘å‹•èˆ‡é»æ“Š) ===
            
            // 1. æ»‘å‹•é–‹å§‹ (Touch Start)
            el.addEventListener('touchstart', (e) => {
                if (isProcessing) return;
                touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                activeTouchTile = tileObj;
            }, {passive: false});

            // 2. é»æ“Šäº’æ› (ä¿ç•™æ»‘é¼ æ“ä½œ)
            el.addEventListener('mousedown', () => handleClick(tileObj));

            return tileObj;
        }

        // === å…¨åŸŸæ»‘å‹•ç›£è½ (Touch Move/End) ===
        // æˆ‘å€‘æŠŠç›£è½åŠ åœ¨ grid ä¸Šï¼Œæˆ–æ˜¯ document ä¸Šæœƒæ›´éˆæ•
        document.addEventListener('touchmove', (e) => {
            // ç¦æ­¢æ»¾å‹•
            if(activeTouchTile) e.preventDefault();
        }, {passive: false});

        document.addEventListener('touchend', (e) => {
            if (!activeTouchTile || isProcessing || !touchStart) return;

            const touchEnd = { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
            const dx = touchEnd.x - touchStart.x;
            const dy = touchEnd.y - touchStart.y;
            
            // åˆ¤æ–·æ»‘å‹•è·é›¢æ˜¯å¦è¶³å¤  (å¤§æ–¼ 30px æ‰ç®—æ»‘å‹•ï¼Œé¿å…èª¤è§¸)
            if (Math.abs(dx) > 30 || Math.abs(dy) > 30) {
                let targetX = activeTouchTile.x;
                let targetY = activeTouchTile.y;

                if (Math.abs(dx) > Math.abs(dy)) {
                    // å·¦å³æ»‘å‹•
                    targetX += dx > 0 ? 1 : -1;
                } else {
                    // ä¸Šä¸‹æ»‘å‹•
                    targetY += dy > 0 ? 1 : -1;
                }

                // æª¢æŸ¥é‚Šç•Œ
                if (targetX >= 0 && targetX < GRID_SIZE && targetY >= 0 && targetY < GRID_SIZE) {
                    const targetTile = grid[targetY][targetX];
                    swapTiles(activeTouchTile, targetTile);
                }
            } else {
                // å¦‚æœæ»‘å‹•è·é›¢å¤ªçŸ­ï¼Œè¦–ç‚ºé»æ“Š
                handleClick(activeTouchTile);
            }

            activeTouchTile = null;
            touchStart = null;
        });

        function handleClick(tile) {
            if(isProcessing) return;
            
            // å¦‚æœæ˜¯ç‰¹æ®Šæ–¹å¡Šï¼Œé»æ“Šç›´æ¥è§¸ç™¼
            if(tile.data.id === 'Bomb' || tile.data.id === 'Mystery') {
                triggerSpecial(tile);
                return;
            }

            if(selectedTile) {
                // æª¢æŸ¥æ˜¯å¦ç›¸é„°
                const dist = Math.abs(selectedTile.x - tile.x) + Math.abs(selectedTile.y - tile.y);
                if(dist === 1) {
                    swapTiles(selectedTile, tile);
                    selectedTile.el.classList.remove('selected');
                    selectedTile = null;
                } else {
                    selectedTile.el.classList.remove('selected');
                    selectedTile = tile;
                    tile.el.classList.add('selected');
                }
            } else {
                selectedTile = tile;
                tile.el.classList.add('selected');
            }
        }

        async function swapTiles(t1, t2) {
            isProcessing = true;
            if(selectedTile) { selectedTile.el.classList.remove('selected'); selectedTile = null; }

            // è¦–è¦ºäº¤æ› (CSS Transform) - é€™è£¡åšç°¡å–®è™•ç†ï¼Œç›´æ¥äº¤æ›è³‡æ–™é‡ç¹ªæ¯”è¼ƒç©©å®š
            const temp = t1.data; t1.data = t2.data; t2.data = temp;
            t1.el.innerHTML = getImg(t1.data);
            t2.el.innerHTML = getImg(t2.data);

            // æª¢æŸ¥æ˜¯å¦æœ‰æ¶ˆé™¤
            const matches = findMatches();
            if (matches.length > 0) {
                await processMatches(matches);
            } else {
                // ç„¡æ•ˆäº¤æ›ï¼šæ™ƒå‹•ä¸¦æ›å›ä¾†
                t1.el.classList.add('shake-anim');
                t2.el.classList.add('shake-anim');
                setTimeout(() => {
                    const temp = t1.data; t1.data = t2.data; t2.data = temp;
                    t1.el.innerHTML = getImg(t1.data);
                    t2.el.innerHTML = getImg(t2.data);
                    t1.el.classList.remove('shake-anim');
                    t2.el.classList.remove('shake-anim');
                    isProcessing = false;
                }, 300);
            }
        }

        function findMatches() {
            let matched = new Set();
            // æ©«å‘
            for(let y=0; y<GRID_SIZE; y++) {
                for(let x=0; x<GRID_SIZE-2; x++) {
                    const a=grid[y][x], b=grid[y][x+1], c=grid[y][x+2];
                    if(a.data.id===b.data.id && b.data.id===c.data.id && !isSpecial(a)) {
                        matched.add(a); matched.add(b); matched.add(c);
                    }
                }
            }
            // ç¸±å‘
            for(let x=0; x<GRID_SIZE; x++) {
                for(let y=0; y<GRID_SIZE-2; y++) {
                    const a=grid[y][x], b=grid[y+1][x], c=grid[y+2][x];
                    if(a.data.id===b.data.id && b.data.id===c.data.id && !isSpecial(a)) {
                        matched.add(a); matched.add(b); matched.add(c);
                    }
                }
            }
            return Array.from(matched);
        }

        function isSpecial(t) { return t.data.id === 'Bomb' || t.data.id === 'Mystery'; }

        async function processMatches(matches) {
            score += matches.length * 10;
            updateUI();
            
            matches.forEach(m => m.el.classList.add('match-anim'));
            await new Promise(r => setTimeout(r, 300));
            
            matches.forEach(m => {
                m.el.classList.remove('match-anim');
                m.data = null; 
                m.el.innerHTML = '';
            });

            await applyGravity();
        }

        async function applyGravity() {
            // ä¸‹è½
            for(let x=0; x<GRID_SIZE; x++) {
                let writeY = GRID_SIZE - 1;
                for(let y=GRID_SIZE-1; y>=0; y--) {
                    if(grid[y][x].data) {
                        if(writeY !== y) {
                            grid[writeY][x].data = grid[y][x].data;
                            grid[writeY][x].el.innerHTML = getImg(grid[writeY][x].data);
                            grid[y][x].data = null;
                            grid[y][x].el.innerHTML = '';
                        }
                        writeY--;
                    }
                }
                // è£œæ»¿ä¸Šæ–¹
                for(let y=writeY; y>=0; y--) {
                    let d = ALL_TILES[Math.floor(Math.random() * ALL_TILES.length)];
                    grid[y][x].data = d;
                    grid[y][x].el.innerHTML = getImg(d);
                }
            }
            
            await new Promise(r => setTimeout(r, 200));
            
            // é€£é–æª¢æŸ¥
            const newMatches = findMatches();
            if(newMatches.length > 0) await processMatches(newMatches);
            else isProcessing = false;
        }

        function triggerSpecial(t) {
            isProcessing = true;
            t.el.classList.add('match-anim');
            setTimeout(async () => {
                score += 500;
                // é€™è£¡ç°¡åŒ–ç‰¹æ®Šæ•ˆæœï¼šå¦‚æœæ˜¯ç‚¸å½ˆï¼Œå‘¨åœ8æ ¼æ¶ˆé™¤ï¼›Mystery å‰‡éš¨æ©Ÿæ¶ˆ
                // ç‚ºæ±‚ç¨‹å¼ç¢¼ç°¡æ½”ï¼Œçµ±ä¸€ç›´æ¥æ¶ˆé™¤è©²æ–¹å¡Šä¸¦åŠ åˆ†ï¼Œä¸¦é€²è¡Œé‡æ•´
                t.data = null; t.el.innerHTML = '';
                t.el.classList.remove('match-anim');
                await applyGravity();
            }, 300);
        }

        function checkMatchesAndRefill() {
            let matches = findMatches();
            while(matches.length > 0) {
                matches.forEach(m => {
                    m.data = ALL_TILES[Math.floor(Math.random() * ALL_TILES.length)];
                    m.el.innerHTML = getImg(m.data);
                });
                matches = findMatches();
            }
        }

        function updateUI() {
            els.score.innerText = score;
            const lvl = Math.floor(score / 1000) + 1;
            els.lvl.innerText = lvl;
            const pct = (score % 1000) / 1000 * 100;
            els.bar.style.width = pct + '%';
        }

        function endGame() {
            clearInterval(gameInterval);
            els.overlay.classList.remove('hidden');
            els.endScn.classList.remove('hidden');
            els.startScn.classList.add('hidden');
            els.finalScore.innerText = score;

            // æ›´æ–°æœ¬æ©Ÿæ’è¡Œæ¦œ
            updateLocalLeaderboard(score);

            if(score > REWARD_SCORE_THRESHOLD) {
                els.rewardBtn.classList.remove('hidden');
            } else {
                els.rewardBtn.classList.add('hidden');
            }
        }

        function startTips() {
            const show = () => {
                els.tips.innerText = TIPS[Math.floor(Math.random() * TIPS.length)];
                els.tips.style.opacity = 0;
                setTimeout(() => els.tips.style.opacity = 1, 100);
            };
            show();
            setInterval(show, 5000);
        }

        // --- æŒ‰éˆ•äº‹ä»¶ ---
        document.getElementById('start-btn').onclick = initGame;
        document.getElementById('restart-btn').onclick = () => {
            els.endScn.classList.add('hidden');
            els.startScn.classList.remove('hidden');
            // é‡æ–°é¡¯ç¤ºæ’è¡Œæ¦œ
            updateLocalLeaderboard(0);
        };

        // é ˜ç (BotBonnie)
        els.rewardBtn.onclick = () => {
            if (liff.isInClient()) {
                liff.sendMessages([{type: 'text', text: BOTBONNIE_KEYWORD}])
                    .then(() => liff.closeWindow());
            } else {
                alert('è«‹åœ¨ LINE é–‹å•Ÿä»¥é ˜å–çå‹µ');
            }
        };

        // åˆ†äº«å¥½å‹ (New)
        document.getElementById('share-btn').onclick = () => {
            if (liff.isApiAvailable('shareTargetPicker')) {
                // å¦‚æœæ˜¯ LIFF ç’°å¢ƒä¸”æ”¯æ´åˆ†äº«
                liff.shareTargetPicker([
                    {
                        type: "text",
                        text: "ğŸ”¥ æˆ‘åœ¨å¥§å¤šæ¯”æ¶ˆæ¶ˆæ¨‚æ‹¿äº† " + score + " åˆ†ï¼\nå¿«ä¾†æŒ‘æˆ°æˆ‘çš„ç´€éŒ„ï¼Œé‚„èƒ½é ˜å–é€šé—œçå‹µå–”ï¼\nğŸ‘‡ é»æ“Šé–‹å§‹ç©ï¼š\nhttps://liff.line.me/" + LIFF_ID 
                    }
                ]).then(res => {
                    if (res) alert("åˆ†äº«æˆåŠŸï¼");
                }).catch(err => {
                    console.error(err);
                    alert("åˆ†äº«åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç›´æ¥åˆ†äº«ç¶²å€ã€‚");
                });
            } else {
                // é›»è…¦ç‰ˆæˆ–ä¸æ”¯æ´æ™‚ï¼Œæ”¹ç‚ºè¤‡è£½é€£çµ
                navigator.clipboard.writeText("https://liff.line.me/" + LIFF_ID)
                    .then(() => alert("é€£çµå·²è¤‡è£½ï¼å¿«å»è²¼çµ¦æœ‹å‹å§ï¼"));
            }
        };

        // åˆå§‹è¼‰å…¥æ’è¡Œæ¦œ
        updateLocalLeaderboard(0);
        initLIFF();

    </script>
</body>
</html>
